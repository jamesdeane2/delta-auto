name: Release tasks
permissions:
  contents: read
  pull-requests: write
on:
  push:
    tags:
      - 'v*'  # Trigger only on version tags like v1.0.0
  workflow_dispatch:
concurrency:
  group: release
  cancel-in-progress: true
jobs:
  # TODO: check if CI passed for tag
  build-apk:
    name: Build app
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build APK
        uses: ./.github/actions/build-apk
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}
          sign-release: false
          # Removed keystore-base64 and sign-base64 - building debug-signed release instead
  create-release:
    name: Create release
    runs-on: ubuntu-latest
    needs: [build-apk]
    if: startsWith(github.ref, 'refs/tags/')  # Only run for tag pushes
    permissions:
      contents: write
      discussions: write
    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: delta-auto-apk
      - name: List downloaded files
        run: ls -la
      - name: Calculate checksum and generate release notes
        run: |
          APK_FILE=$(ls delta-auto-*.apk | head -n 1)
          cat << "EOF" >> release_notes.txt
          ### Delta Auto - Custom Build with Auto Enable on BT

          This is a custom build of Delta with automatic hotspot control based on Bluetooth device connection.

          ### Checksum

          ```sh
          $ sha256sum ${APK_FILE}
          EOF

          sha256sum ${APK_FILE} >> release_notes.txt

          cat << "EOF" >> release_notes.txt
          ```

          Check the checksum after downloading the APK using `sha256sum` to ensure integrity of the file.
          EOF
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: true
          prerelease: false
          files: delta-auto-*.apk
          discussion_category_name: Announcements
          body_path: release_notes.txt
